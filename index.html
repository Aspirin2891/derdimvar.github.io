<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dertleş ve Derman Bul</title>
<style>
  body { margin:0; font-family:Arial; background:#f4f6f9; }
  header { background:linear-gradient(90deg,#ff7a00,#0066cc); color:white; padding:25px; text-align:center; }
  nav { background:white; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .container { max-width:1000px; margin:30px auto; padding:20px; }
  .card { background:white; padding:20px; margin-bottom:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
  .card.clickable { cursor:pointer; }
  .card.clickable:hover { background:#f2f2f2; }
  button { background:#0066cc; color:white; padding:10px 15px; border:none; border-radius:6px; cursor:pointer;}
  button:hover{ background:#004999;}
  input,textarea{ width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;}
  .topic{ padding:10px; border-bottom:1px solid #eee; cursor:pointer;}
  .topic:hover{ background:#f2f2f2;}
  .reply{ padding:8px; border-bottom:1px solid #eee;}
  .hidden{ display:none;}
  .row { display:flex; gap:10px; align-items:center; }
  .row > * { flex:1; }
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>

<header>
  <h1>Dertleş ve Derman Bul</h1>
  <div class="muted">Samimi • Güvenilir • Çözüm Odaklı</div>
</header>

<nav>
  <div id="userArea">Giriş yapılmadı</div>
  <div id="authButtons" class="row" style="flex:0 0 auto;">
    <button onclick="showLogin()">Giriş</button>
    <button onclick="showRegister()">Kayıt Ol</button>
  </div>
</nav>

<div class="container">

  <!-- AUTH BOX -->
  <div id="authBox" class="card hidden">
    <h3 id="authTitle">Giriş Yap</h3>

    <!-- SADECE KAYITTA GÖSTER -->
    <input type="text" id="authUsername" placeholder="Kullanıcı adı (örn: Ali34)" class="hidden" />

    <input type="email" id="authEmail" placeholder="Email" />
    <input type="password" id="authPassword" placeholder="Şifre (en az 6 karakter)" />
    <button id="authAction">Devam Et</button>
    <button style="background:#888; margin-left:8px;" onclick="hideAuth()">Kapat</button>
  </div>

  <!-- CATEGORIES -->
  <div id="categoriesSection">
    <h2>Kategoriler</h2>
    <div id="categories"></div>
  </div>

  <!-- TOPICS -->
  <div id="topicsSection" class="hidden">
    <button onclick="goBack()">← Geri</button>
    <h2 id="categoryTitle"></h2>
    <div id="topicsList"></div>

    <div id="createTopicBox" class="card" style="margin-top:20px;">
      <h3>Yeni Konu Aç</h3>
      <input type="text" id="topicTitle" placeholder="Konu başlığı" />
      <textarea id="topicContent" placeholder="Detaylı anlat..."></textarea>
      <button id="createTopic">Konu Oluştur</button>
    </div>
  </div>

  <!-- TOPIC DETAIL -->
  <div id="topicDetail" class="hidden">
    <button onclick="backToTopics()">← Geri</button>
    <h2 id="detailTitle"></h2>
    <p id="detailContent"></p>

    <h3>Yanıtlar</h3>
    <div id="replies"></div>

    <textarea id="replyText" placeholder="Cevap yaz..."></textarea>
    <button id="sendReply">Yanıt Gönder</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  onValue,
  push,
  set,
  get
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAllhg1GM46bF9KKGv2t20uBb4xMSaEMnQ",
  authDomain: "derdimvar-c0642.firebaseapp.com",
  databaseURL: "https://derdimvar-c0642-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "derdimvar-c0642",
  storageBucket: "derdimvar-c0642.appspot.com",
  messagingSenderId: "113627224046",
  appId: "1:113627224046:web:1aae2416c21916d1b560ff"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* DOM */
const userArea = document.getElementById("userArea");
const authButtons = document.getElementById("authButtons");

const authBox = document.getElementById("authBox");
const authTitle = document.getElementById("authTitle");
const authUsername = document.getElementById("authUsername");
const authEmail = document.getElementById("authEmail");
const authPassword = document.getElementById("authPassword");
const authAction = document.getElementById("authAction");

const categoriesSection = document.getElementById("categoriesSection");
const topicsSection = document.getElementById("topicsSection");
const topicDetail = document.getElementById("topicDetail");

const categories = document.getElementById("categories");
const categoryTitle = document.getElementById("categoryTitle");
const topicsList = document.getElementById("topicsList");

const topicTitle = document.getElementById("topicTitle");
const topicContent = document.getElementById("topicContent");
const createTopic = document.getElementById("createTopic");

const detailTitle = document.getElementById("detailTitle");
const detailContent = document.getElementById("detailContent");
const replies = document.getElementById("replies");
const replyText = document.getElementById("replyText");
const sendReply = document.getElementById("sendReply");

/* State */
let authMode = "login";
let currentCategory = null;
let currentTopicId = null;
let topicsCache = {};
let currentUsername = ""; // ✅ artık yazar bu

/* Auth UI */
window.hideAuth = () => authBox.classList.add("hidden");

window.showLogin = function () {
  authMode = "login";
  authTitle.innerText = "Giriş Yap";
  authUsername.classList.add("hidden"); // login’de gizle
  authBox.classList.remove("hidden");
};

window.showRegister = function () {
  authMode = "register";
  authTitle.innerText = "Kayıt Ol";
  authUsername.classList.remove("hidden"); // register’da göster
  authBox.classList.remove("hidden");
};

authAction.onclick = async () => {
  const email = authEmail.value.trim();
  const password = authPassword.value;

  try {
    if (authMode === "login") {
      await signInWithEmailAndPassword(auth, email, password);
      alert("Giriş başarılı!");
    } else {
      const username = authUsername.value.trim();
      if (!username) return alert("Kullanıcı adı boş olamaz!");
      if (password.length < 6) return alert("Şifre en az 6 karakter olmalı.");

      const userCred = await createUserWithEmailAndPassword(auth, email, password);

      // ✅ users/{uid} profili yaz
      await set(ref(db, "users/" + userCred.user.uid), {
        username,
        email,
        createdAt: Date.now()
      });

      alert("Kayıt başarılı!");
    }

    authBox.classList.add("hidden");
    authEmail.value = "";
    authPassword.value = "";
    authUsername.value = "";
  } catch (e) {
    alert("Hata: " + e.message);
  }
};

window.logout = async function () {
  await signOut(auth);
  alert("Çıkış yapıldı");
};

/* Auth state -> username çek */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // users/{uid} içinden username çek
    try {
      const snap = await get(ref(db, "users/" + user.uid));
      const profile = snap.val();
      currentUsername = profile?.username || user.email;
    } catch {
      currentUsername = user.email;
    }

    userArea.innerHTML = `${currentUsername} <button onclick="logout()">Çıkış</button>`;
    authButtons.style.display = "none";
  } else {
    currentUsername = "";
    userArea.innerText = "Giriş yapılmadı";
    authButtons.style.display = "block";
  }
});

/* Categories list */
onValue(ref(db, "categories"), (snapshot) => {
  const data = snapshot.val();
  categories.innerHTML = "";

  if (!data) {
    categories.innerHTML = "<div class='card'>Henüz kategori yok</div>";
    return;
  }

  for (const id in data) {
    categories.innerHTML += `
      <div class="card clickable" data-cat="${id}" data-name="${data[id].name}">
        ${data[id].name}
      </div>
    `;
  }
});

/* Category click */
categories.addEventListener("click", (e) => {
  const card = e.target.closest(".card");
  if (!card) return;
  const id = card.getAttribute("data-cat");
  const name = card.getAttribute("data-name");
  window.openCategory(id, name);
});

window.openCategory = function (id, name) {
  if (!auth.currentUser) {
    alert("Kategoriyi görmek için giriş yapmalısın!");
    return;
  }

  currentCategory = id;
  categoryTitle.innerText = name;

  categoriesSection.classList.add("hidden");
  topicsSection.classList.remove("hidden");
  topicDetail.classList.add("hidden");

  renderTopics();
};

/* Topics cache (hafif) */
onValue(ref(db, "topics"), (snapshot) => {
  topicsCache = snapshot.val() || {};
  if (!topicsSection.classList.contains("hidden")) renderTopics();
});

function renderTopics() {
  topicsList.innerHTML = "";
  const ids = Object.keys(topicsCache || {});
  if (!currentCategory || ids.length === 0) return;

  for (const id of ids) {
    const t = topicsCache[id];
    if (t.category !== currentCategory) continue;

    topicsList.innerHTML += `
      <div class="topic" data-id="${id}">
        <strong>${t.title}</strong><br>
        <small>${t.author || ""}</small>
      </div>
    `;
  }
}

/* Topic click */
topicsList.addEventListener("click", (e) => {
  const t = e.target.closest(".topic");
  if (!t) return;
  const id = t.getAttribute("data-id");
  window.openTopic(id);
});

/* Topic detail (tek sefer okuma - kasmasın) */
window.openTopic = async function (id) {
  currentTopicId = id;

  topicsSection.classList.add("hidden");
  topicDetail.classList.remove("hidden");

  const snap = await get(ref(db, "topics/" + id));
  const data = snap.val();
  if (!data) return;

  detailTitle.innerText = data.title || "";
  detailContent.innerText = data.content || "";

  replies.innerHTML = "";
  if (data.replies) {
    for (const r in data.replies) {
      replies.innerHTML += `
        <div class="reply">
          <strong>${data.replies[r].author || ""}</strong><br>
          ${data.replies[r].text || ""}
        </div>
      `;
    }
  }
};

/* Create topic */
createTopic.onclick = () => {
  if (!auth.currentUser) return alert("Giriş yapmalısın!");
  if (!currentCategory) return alert("Önce kategori seç!");

  const title = topicTitle.value.trim();
  const content = topicContent.value.trim();
  if (!title) return alert("Konu başlığı boş olamaz!");

  push(ref(db, "topics"), {
    category: currentCategory,
    title,
    content,
    author: currentUsername || auth.currentUser.email, // ✅ username
    createdAt: Date.now()
  });

  topicTitle.value = "";
  topicContent.value = "";
};

/* Send reply */
sendReply.onclick = async () => {
  if (!auth.currentUser) return alert("Yanıt yazmak için giriş yapmalısın!");
  if (!currentTopicId) return;

  const text = replyText.value.trim();
  if (!text) return alert("Yanıt boş olamaz!");

  await push(ref(db, "topics/" + currentTopicId + "/replies"), {
    text,
    author: currentUsername || auth.currentUser.email, // ✅ username
    createdAt: Date.now()
  });

  replyText.value = "";
  // Detayı yenile (tek sefer tekrar çek)
  window.openTopic(currentTopicId);
};

/* Navigation */
window.goBack = function () {
  topicsSection.classList.add("hidden");
  topicDetail.classList.add("hidden");
  categoriesSection.classList.remove("hidden");
  currentCategory = null;
};

window.backToTopics = function () {
  topicDetail.classList.add("hidden");
  topicsSection.classList.remove("hidden");
};
</script>

</body>
</html>

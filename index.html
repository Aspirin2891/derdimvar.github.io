<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DertleÅŸ ve Derman Bul</title>

<style>
body { margin:0; font-family:Arial; background:#f4f6f9; }
header { background:linear-gradient(90deg,#ff7a00,#0066cc); color:white; padding:25px; text-align:center; }
nav { background:white; padding:15px 30px; display:flex; justify-content:space-between; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.container { max-width:1000px; margin:30px auto; padding:20px; }
.card { background:white; padding:20px; margin-bottom:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); cursor:pointer;}
.card:hover { background:#f2f2f2; }
button { background:#0066cc; color:white; padding:10px 15px; border:none; border-radius:6px; cursor:pointer;}
button:hover{ background:#004999;}
input,textarea{ width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;}
.topic{ padding:10px; border-bottom:1px solid #eee; cursor:pointer;}
.topic:hover{ background:#f2f2f2;}
.reply{ padding:8px; border-bottom:1px solid #eee;}
.hidden{ display:none;}
</style>
</head>
<body>

<header>
<h1>DertleÅŸ ve Derman Bul</h1>
</header>

<nav>
  <div id="userArea"></div>
  <div id="authButtons">
    <button onclick="showLogin()">GiriÅŸ</button>
    <button onclick="showRegister()">KayÄ±t Ol</button>
  </div>
</nav>

<div class="container">
<div id="authBox" class="card hidden">
  <h3 id="authTitle">GiriÅŸ Yap</h3>
  <input type="email" id="authEmail" placeholder="Email">
  <input type="password" id="authPassword" placeholder="Åifre">
  <button id="authAction">Devam Et</button>
</div>
<div id="categoriesSection">
<h2>Kategoriler</h2>
<div id="categories"></div>
</div>

<div id="topicsSection" class="hidden">
<button onclick="goBack()">â† Geri</button>
<h2 id="categoryTitle"></h2>

<div id="topicsList"></div>

<div id="createTopicBox" style="margin-top:20px;">
<h3>Yeni Konu AÃ§</h3>
<input type="text" id="topicTitle" placeholder="Konu baÅŸlÄ±ÄŸÄ±">
<textarea id="topicContent" placeholder="DetaylÄ± anlat..."></textarea>
<button id="createTopic">Konu OluÅŸtur</button>
</div>
</div>

<div id="topicDetail" class="hidden">
<button onclick="backToTopics()">â† Geri</button>
<h2 id="detailTitle"></h2>
<p id="detailContent"></p>

<h3>YanÄ±tlar</h3>
<div id="replies"></div>

<textarea id="replyText" placeholder="Cevap yaz..."></textarea>
<button id="sendReply">YanÄ±t GÃ¶nder</button>
</div>

</div>

<script type="module">

/* ğŸ”¹ 1ï¸âƒ£ TÃœM IMPORTLAR EN ÃœSTTE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getDatabase,
  ref,
  set,
  onValue,
  push
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ğŸ”¹ 2ï¸âƒ£ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAllhg1GM46bF9KKGv2t20uBb4xMSaEMnQ",
  authDomain: "derdimvar-c0642.firebaseapp.com",
  databaseURL: "https://derdimvar-c0642-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "derdimvar-c0642",
  storageBucket: "derdimvar-c0642.appspot.com",
  messagingSenderId: "113627224046",
  appId: "1:113627224046:web:1aae2416c21916d1b560ff"
};

 
/* ğŸ”¹ 3ï¸âƒ£ APP BAÅLAT */
const app = initializeApp(firebaseConfig);

/* ğŸ”¹ 4ï¸âƒ£ AUTH VE DATABASE OLUÅTUR */
const auth = getAuth(app);
const db = getDatabase(app);
// DOM
const elCategoriesSection = document.getElementById("categoriesSection");
const elTopicsSection = document.getElementById("topicsSection");
const elTopicDetail = document.getElementById("topicDetail");

const elCategoryTitle = document.getElementById("categoryTitle");
const elTopicsList = document.getElementById("topicsList");

const elDetailTitle = document.getElementById("detailTitle");
const elDetailContent = document.getElementById("detailContent");
const elReplies = document.getElementById("replies");

// State
let currentCategory = null;
let currentTopicId = null;
let topicsCache = {}; // ğŸ”¥ konularÄ± burada tutacaÄŸÄ±z

/* ğŸ”¹ 5ï¸âƒ£ AUTH UI KODLARI */
let authMode = "login";

window.showLogin = function(){
  authMode = "login";
  authTitle.innerText = "GiriÅŸ Yap";
  authBox.classList.remove("hidden");
};

window.showRegister = function(){
  authMode = "register";
  authTitle.innerText = "KayÄ±t Ol";
  authBox.classList.remove("hidden");
};

authAction.onclick = async () => {
  const email = authEmail.value;
  const password = authPassword.value;

  try{
    if(authMode === "login"){
      await signInWithEmailAndPassword(auth, email, password);
      alert("GiriÅŸ baÅŸarÄ±lÄ±!");
    } else {
      await createUserWithEmailAndPassword(auth, email, password);
      alert("KayÄ±t baÅŸarÄ±lÄ±!");
    }

    authBox.classList.add("hidden");
    authEmail.value="";
    authPassword.value="";
  }catch(error){
    alert("Hata: " + error.message);
  }
};

onAuthStateChanged(auth, user => {
  if(user){
    userArea.innerHTML = `
      ${user.email}
      <button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
    `;
    authButtons.style.display="none";
  }else{
    userArea.innerText="GiriÅŸ yapÄ±lmadÄ±";
    authButtons.style.display="block";
  }
});

window.logout = async function(){
  await signOut(auth);
  alert("Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±");
};

/* Ä°lk aÃ§Ä±lÄ±ÅŸta kategorileri oluÅŸtur */
set(ref(db,"categories/dertlesme"),{name:"DertleÅŸme"});
set(ref(db,"categories/tamirat"),{name:"Tamirat"});
set(ref(db,"categories/kendinyap"),{name:"Kendin Yap"});

/* Kategorileri Listele */
function renderTopics() {
  elTopicsList.innerHTML = "";

  const ids = Object.keys(topicsCache || {});
  if (!currentCategory || ids.length === 0) return;

  for (const id of ids) {
    const t = topicsCache[id];
    if (t.category !== currentCategory) continue;

    elTopicsList.innerHTML += `
      <div class="topic" data-id="${id}">
        <strong>${t.title}</strong><br>
        <small>${t.author}</small>
      </div>
    `;
  }
}

// ğŸ”¥ Her veri deÄŸiÅŸtiÄŸinde cache gÃ¼ncellenir
onValue(ref(db, "topics"), (snapshot) => {
  topicsCache = snapshot.val() || {};
  renderTopics(); // ekranda hangi kategori aÃ§Ä±ksa ona gÃ¶re Ã§iz
});

// ğŸ”¥ TÄ±klamayÄ± inline onclick yerine event delegation ile yakalayalÄ±m (daha saÄŸlam)
elTopicsList.addEventListener("click", (e) => {
  const box = e.target.closest(".topic");
  if (!box) return;
  const id = box.getAttribute("data-id");
  window.openTopic(id);
});

window.openCategory = function(id, name) {
  if (!auth.currentUser) {
    alert("Kategoriyi gÃ¶rmek iÃ§in giriÅŸ yapmalÄ±sÄ±n!");
    return;
  }

  currentCategory = id;
  elCategoryTitle.innerText = name;

  elCategoriesSection.classList.add("hidden");
  elTopicsSection.classList.remove("hidden");

  renderTopics(); // ğŸ”¥ kategori deÄŸiÅŸtiÄŸi an listeyi yenile
};
  /* Konu oluÅŸtur */
createTopic.onclick=()=>{
  if(!auth.currentUser) return alert("GiriÅŸ yapmalÄ±sÄ±n!");

  push(ref(db,"topics"),{
    category: currentCategory,
    title: topicTitle.value,
    content: topicContent.value,
    author: auth.currentUser.email
  });

  topicTitle.value="";
  topicContent.value="";
};

/* KonularÄ± Listele */
onValue(ref(db,"topics"), snapshot=>{
  const data = snapshot.val();
  topicsList.innerHTML="";
  if(!data) return;

  for(let id in data){
    if(data[id].category===currentCategory){
      topicsList.innerHTML+=`
        <div class="topic" onclick="openTopic('${id}')">
          <strong>${data[id].title}</strong><br>
          <small>${data[id].author}</small>
        </div>
      `;
    }
  }
});

window.openTopic=function(id){
  currentTopicId=id;
  topicsSection.classList.add("hidden");
  topicDetail.classList.remove("hidden");

  onValue(ref(db,"topics/"+id), snapshot=>{
    const data=snapshot.val();
    detailTitle.innerText=data.title;
    detailContent.innerText=data.content;
    replies.innerHTML="";
    if(data.replies){
      for(let r in data.replies){
        replies.innerHTML+=`
          <div class="reply">
            <strong>${data.replies[r].author}</strong><br>
            ${data.replies[r].text}
          </div>
        `;
      }
    }
  });
};

sendReply.onclick = () => {

  if(!auth.currentUser){
    alert("YanÄ±t yazmak iÃ§in giriÅŸ yapmalÄ±sÄ±n!");
    return;
  }

  push(ref(db,"topics/"+currentTopicId+"/replies"),{
    text: replyText.value,
    author: auth.currentUser.email
  });

  replyText.value="";
};

window.goBack=function(){
  topicsSection.classList.add("hidden");
  categoriesSection.classList.remove("hidden");
};

window.backToTopics=function(){
  topicDetail.classList.add("hidden");
  topicsSection.classList.remove("hidden");
};

</script>

</body>
</html>
